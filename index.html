<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Gerador Final â€“ Representantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- SheetJS para ler Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js para grÃ¡ficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --accent: #0ea5e9;
      --accent-soft: rgba(14,165,233,0.16);
      --text: #e5e7eb;
      --muted: #9ca3af;
      --danger: #ef4444;
      --success: #22c55e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000 100%);
      color: var(--text);
      min-height: 100vh;
    }

    header {
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      background: linear-gradient(90deg, #020617, #020617e0, #020617);
      border-bottom: 1px solid #1e293b;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header .title-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    header span.subtitle {
      font-size: 13px;
      color: var(--muted);
    }

    .upload-area {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    input[type="file"] {
      display: none;
    }

    .file-label {
      cursor: pointer;
      border-radius: 999px;
      border: 1px dashed #1e293b;
      padding: 7px 12px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      background: #020617;
    }

    .file-name {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }

    main {
      padding: 18px 20px 32px;
      max-width: 1400px;
      margin: 0 auto;
    }

    .card {
      background: radial-gradient(circle at top, rgba(15,23,42,0.92), #020617);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.18);
      padding: 16px 16px 14px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.65);
      position: relative;
      overflow: hidden;
      margin-bottom: 16px;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at top, rgba(56,189,248,0.14), transparent 55%);
      opacity: 0.7;
      pointer-events: none;
      z-index: -1;
    }

    .card h2 {
      font-size: 15px;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: var(--muted);
    }

    .caption {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    .resumo-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 8px;
    }

    .mini-card {
      padding: 10px 12px;
      border-radius: 14px;
      background: #020617f0;
      border: 1px solid rgba(148,163,184,0.3);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mini-label {
      font-size: 11px;
      color: var(--muted);
    }

    .mini-value {
      font-size: 15px;
      font-weight: 600;
    }

    .mini-extra {
      font-size: 11px;
      color: var(--muted);
    }

    .mini-extra.ok {
      color: var(--success);
    }

    .mini-extra.bad {
      color: var(--danger);
    }

    .layout-top {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 2fr);
      gap: 16px;
      margin-top: 4px;
      margin-bottom: 16px;
    }

    .filters-block {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    .filters-row label {
      font-size: 11px;
      color: var(--muted);
    }

    .filters-row select {
      background: #020617;
      border-radius: 999px;
      border: 1px solid #1e293b;
      padding: 5px 9px;
      font-size: 12px;
      color: var(--text);
      min-width: 110px;
      outline: none;
    }

    .week-selector {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .week-btn {
      border-radius: 999px;
      border: 1px solid #1e293b;
      background: #020617;
      color: var(--muted);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      transition: 0.12s ease;
    }

    .week-btn.active {
      background: var(--accent-soft);
      border-color: var(--accent);
      color: var(--text);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }

    .charts-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr);
      gap: 16px;
      margin-bottom: 16px;
    }

    .chart-wrapper {
      margin-top: 6px;
      height: 270px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      font-size: 12px;
      margin-top: 8px;
    }

    thead {
      background: rgba(15,23,42,0.96);
    }

    th, td {
      padding: 6px 8px;
      text-align: left;
      border-bottom: 1px solid rgba(30,41,59,0.95);
      white-space: nowrap;
    }

    th {
      font-size: 11px;
      color: var(--muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    tbody tr:nth-child(even) {
      background: rgba(15,23,42,0.45);
    }

    tbody tr:hover {
      background: rgba(56,189,248,0.08);
    }

    .align-right {
      text-align: right;
    }

    .status-ok {
      color: var(--success);
    }

    .status-bad {
      color: var(--danger);
    }

    .empty {
      font-size: 12px;
      color: var(--muted);
      margin-top: 10px;
    }

    @media (max-width: 1120px) {
      .charts-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    @media (max-width: 950px) {
      .layout-top {
        grid-template-columns: minmax(0, 1fr);
      }
      header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    @media (max-width: 720px) {
      main {
        padding-inline: 12px;
      }
      .resumo-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (max-width: 520px) {
      .resumo-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="title-block">
      <h1>Gerador Final â€“ Representantes</h1>
      <span class="subtitle">Dashboard semanal (Semana 1 a 5) por Estado e Representante</span>
    </div>

    <div class="upload-area">
      <label class="file-label">
        <span>ðŸ“„ Selecionar planilha (.xlsx)</span>
        <span class="file-name" id="fileName">Nenhum arquivo</span>
        <input type="file" id="fileInput" accept=".xlsx,.xls" />
      </label>
    </div>
  </header>

  <main>
    <!-- RESUMO GERAL -->
    <section class="card">
      <h2>
        VisÃ£o geral do mÃªs
        <span class="badge" id="badgeMes">Sem dados</span>
      </h2>
      <p class="caption">Resumo geral calculado automaticamente a partir do arquivo importado (Meta Mensal x Atingido).</p>

      <div class="resumo-grid">
        <div class="mini-card">
          <span class="mini-label">Total de representantes (linhas vÃ¡lidas)</span>
          <span class="mini-value" id="totalReps">â€“</span>
          <span class="mini-extra">Apenas linhas com representante preenchido</span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Meta total mensal</span>
          <span class="mini-value" id="metaTotal">R$ 0,00</span>
          <span class="mini-extra">SomatÃ³rio da coluna "Meta Mensal"</span>
        </div>
        <div class="mini-card">
          <span class="mini-label">Atingido total no mÃªs</span>
          <span class="mini-value" id="vendasTotais">R$ 0,00</span>
          <span class="mini-extra" id="percGeral">Meta geral: â€“</span>
        </div>
      </div>
    </section>

    <!-- FILTROS + GRÃFICO REPRESENTANTES -->
    <div class="layout-top">
      <section class="card">
        <h2>Filtros de anÃ¡lise</h2>
        <p class="caption">Selecione o Estado e a Semana para ver o desempenho dos representantes.</p>

        <div class="filters-block">
          <div class="filters-row">
            <label for="estadoFiltro">Estado:</label>
            <select id="estadoFiltro">
              <option value="__ALL__">Todos</option>
            </select>
          </div>

          <div>
            <span class="mini-label">Semana:</span>
            <div class="week-selector">
              <button class="week-btn active" data-week="0">Semana 1</button>
              <button class="week-btn" data-week="1">Semana 2</button>
              <button class="week-btn" data-week="2">Semana 3</button>
              <button class="week-btn" data-week="3">Semana 4</button>
              <button class="week-btn" data-week="4">Semana 5</button>
            </div>
          </div>

          <div class="mini-card">
            <span class="mini-label" id="resumoFiltroTitulo">Resumo do filtro</span>
            <span class="mini-value" id="resumoFiltroValores">Meta R$ 0,00 Â· Atingido R$ 0,00</span>
            <span class="mini-extra" id="resumoFiltroPerc">Atingimento: â€“</span>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Meta x Atingido por Representante</h2>
        <p class="caption">Representantes do estado selecionado, focado na semana escolhida.</p>
        <div class="chart-wrapper">
          <canvas id="chartRepsSemana"></canvas>
        </div>
      </section>
    </div>

    <!-- GRÃFICOS ESTADO + RANKING -->
    <div class="charts-grid">
      <section class="card">
        <h2>Meta x Atingido por Estado (Semana selecionada)</h2>
        <p class="caption">SomatÃ³rio das metas e atingidos da semana, agrupado por UF.</p>
        <div class="chart-wrapper">
          <canvas id="chartEstadosSemana"></canvas>
        </div>
      </section>

      <section class="card">
        <h2>Ranking de Representantes (Atingido no mÃªs)</h2>
        <p class="caption">Top representantes pelo valor atingido no mÃªs, respeitando o filtro de Estado.</p>
        <div class="chart-wrapper">
          <canvas id="chartRankingMes"></canvas>
        </div>
      </section>
    </div>

    <!-- TABELA DETALHADA -->
    <section class="card">
      <h2>Detalhamento por Estado, Representante e Semana</h2>
      <p class="caption">
        Dados lidos diretamente da planilha: Estado, Representante, Meta e Atingido em cada semana, mais totals do mÃªs.
      </p>

      <div id="tabelaContainer">
        <p class="empty" id="msgVazio">
          Importe a planilha para visualizar a tabela.
        </p>

        <table id="tabelaDados" style="display:none;">
          <thead>
            <tr>
              <th>Estado</th>
              <th>Representante</th>
              <th class="align-right">Meta MÃªs</th>
              <th class="align-right">Atingido MÃªs</th>
              <th class="align-right">% MÃªs</th>
              <th class="align-right">Sem 1 Meta</th>
              <th class="align-right">Sem 1 Ating.</th>
              <th class="align-right">Sem 2 Meta</th>
              <th class="align-right">Sem 2 Ating.</th>
              <th class="align-right">Sem 3 Meta</th>
              <th class="align-right">Sem 3 Ating.</th>
              <th class="align-right">Sem 4 Meta</th>
              <th class="align-right">Sem 4 Ating.</th>
              <th class="align-right">Sem 5 Meta</th>
              <th class="align-right">Sem 5 Ating.</th>
            </tr>
          </thead>
          <tbody id="tbodyDados"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script>
    const fileInput = document.getElementById('fileInput');
    const fileNameSpan = document.getElementById('fileName');

    let registros = []; // base completa
    let currentWeekIndex = 0; // 0 a 4

    let chartRepsSemana = null;
    let chartEstadosSemana = null;
    let chartRankingMes = null;

    fileInput.addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (!file) return;
      fileNameSpan.textContent = file.name;

      const reader = new FileReader();
      reader.onload = function (evt) {
        const data = new Uint8Array(evt.target.result);
        const workbook = XLSX.read(data, { type: 'array' });

        const firstSheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheetName];

        // header:1 -> array de arrays, preservando toda estrutura
        const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
        processarPlanilha(rows);
      };
      reader.readAsArrayBuffer(file);
    });

    function safeStr(v) {
      if (v === null || v === undefined) return "";
      return String(v).trim();
    }

    function toNumber(v) {
      if (v === null || v === undefined || v === "") return 0;
      if (typeof v === "number") return v;
      const limpo = String(v).replace(/\./g, "").replace(",", ".");
      const num = parseFloat(limpo);
      return isNaN(num) ? 0 : num;
    }

    function formatCurrency(v) {
      return v.toLocaleString("pt-BR", { style: "currency", currency: "BRL" });
    }

    function formatPercent(v) {
      if (!isFinite(v)) return "â€“";
      return (v * 100).toLocaleString("pt-BR", { minimumFractionDigits: 1, maximumFractionDigits: 1 }) + " %";
    }

    function processarPlanilha(rows) {
      registros = [];
      let lastEstado = "";

      let totalMeta = 0;
      let totalAtingido = 0;

      // pega nome do mÃªs na linha 3, col 3 (onde aparece "Outubro" / "Novembro" etc)
      let nomeMes = "";
      if (rows[2] && rows[2][3]) {
        nomeMes = safeStr(rows[2][3]);
      }
      document.getElementById("badgeMes").textContent = nomeMes || "MÃªs nÃ£o informado";

      // LINHA 3 (Ã­ndice 3) Ã© o cabeÃ§alho com os tÃ­tulos
      // dados comeÃ§am na linha 5 da planilha (Ã­ndice 4)
      for (let i = 4; i < rows.length; i++) {
        const row = rows[i] || [];

        const repNome = safeStr(row[2]);
        if (!repNome) continue;
        if (repNome.toUpperCase().startsWith("TOTAL")) continue; // pula totalizadores

        let estadoCell = safeStr(row[1]);
        if (estadoCell) {
          lastEstado = estadoCell;
        }
        const estado = lastEstado || "N/I";

        // colunas conforme estrutura do ALEXANDRE.xlsx
        const metaMensal = toNumber(row[17]);   // "Meta Mensal"
        const atingMensal = toNumber(row[18]); // "Atingido"
        const percMes = metaMensal > 0 ? atingMensal / metaMensal : 0;

        const sem1Meta = toNumber(row[6]);
        const sem1Ating = toNumber(row[7]);
        const sem2Meta = toNumber(row[8]);
        const sem2Ating = toNumber(row[9]);
        const sem3Meta = toNumber(row[10]);
        const sem3Ating = toNumber(row[11]);
        const sem4Meta = toNumber(row[12]);
        const sem4Ating = toNumber(row[13]);
        const sem5Meta = toNumber(row[14]);
        const sem5Ating = toNumber(row[15]);

        const semanasMeta = [sem1Meta, sem2Meta, sem3Meta, sem4Meta, sem5Meta];
        const semanasAting = [sem1Ating, sem2Ating, sem3Ating, sem4Ating, sem5Ating];

        registros.push({
          estado,
          representante: repNome,
          metaMensal,
          atingMensal,
          percMes,
          semanasMeta,
          semanasAting
        });

        totalMeta += metaMensal;
        totalAtingido += atingMensal;
      }

      atualizarResumo(totalMeta, totalAtingido);
      popularFiltroEstados();
      montarTabela();
      atualizarTudo(); // atualiza grÃ¡ficos e resumo de filtro
    }

    function atualizarResumo(totalMeta, totalAtingido) {
      document.getElementById("totalReps").textContent = registros.length;
      document.getElementById("metaTotal").textContent = formatCurrency(totalMeta);
      document.getElementById("vendasTotais").textContent = formatCurrency(totalAtingido);

      let texto = "Meta geral: â€“";
      if (totalMeta > 0) {
        const perc = totalAtingido / totalMeta;
        texto = "Meta geral: " + formatPercent(perc);
        document.getElementById("percGeral").className = "mini-extra " + (perc >= 1 ? "ok" : "bad");
      } else {
        document.getElementById("percGeral").className = "mini-extra";
      }
      document.getElementById("percGeral").textContent = texto;
    }

    function popularFiltroEstados() {
      const select = document.getElementById("estadoFiltro");
      select.innerHTML = "";
      const optTodos = document.createElement("option");
      optTodos.value = "__ALL__";
      optTodos.textContent = "Todos";
      select.appendChild(optTodos);

      const estadosSet = new Set(registros.map(r => r.estado));
      Array.from(estadosSet).sort().forEach(uf => {
        const opt = document.createElement("option");
        opt.value = uf;
        opt.textContent = uf;
        select.appendChild(opt);
      });

      select.value = "__ALL__";
      select.onchange = atualizarTudo;
    }

    function getRegistrosFiltrados() {
      const ufSel = document.getElementById("estadoFiltro").value;
      if (ufSel === "__ALL__") return registros;
      return registros.filter(r => r.estado === ufSel);
    }

    function atualizarResumoFiltro() {
      const ufSel = document.getElementById("estadoFiltro").value;
      const semanaIndex = currentWeekIndex;
      const regs = getRegistrosFiltrados();

      let metaSemana = 0;
      let atingSemana = 0;

      regs.forEach(r => {
        metaSemana += r.semanasMeta[semanaIndex] || 0;
        atingSemana += r.semanasAting[semanaIndex] || 0;
      });

      const perc = metaSemana > 0 ? (atingSemana / metaSemana) : NaN;
      const nomeSemana = "Semana " + (semanaIndex + 1);
      const ufTexto = (ufSel === "__ALL__") ? "Todos os estados" : ("Estado " + ufSel);

      document.getElementById("resumoFiltroTitulo").textContent =
        `${ufTexto} Â· ${nomeSemana}`;

      document.getElementById("resumoFiltroValores").textContent =
        `Meta ${formatCurrency(metaSemana)} Â· Atingido ${formatCurrency(atingSemana)}`;

      const elemPerc = document.getElementById("resumoFiltroPerc");
      if (metaSemana > 0) {
        elemPerc.textContent = "Atingimento: " + formatPercent(perc);
        elemPerc.className = "mini-extra " + (perc >= 1 ? "ok" : "bad");
      } else {
        elemPerc.textContent = "Atingimento: â€“";
        elemPerc.className = "mini-extra";
      }
    }

    function montarTabela() {
      const tbody = document.getElementById("tbodyDados");
      const tabela = document.getElementById("tabelaDados");
      const msgVazio = document.getElementById("msgVazio");

      tbody.innerHTML = "";

      if (!registros.length) {
        tabela.style.display = "none";
        msgVazio.style.display = "block";
        return;
      }

      msgVazio.style.display = "none";
      tabela.style.display = "table";

      registros.forEach(r => {
        const tr = document.createElement("tr");

        const tdEstado = document.createElement("td");
        tdEstado.textContent = r.estado;

        const tdRep = document.createElement("td");
        tdRep.textContent = r.representante;

        const tdMetaMes = document.createElement("td");
        tdMetaMes.className = "align-right";
        tdMetaMes.textContent = formatCurrency(r.metaMensal);

        const tdAtingMes = document.createElement("td");
        tdAtingMes.className = "align-right";
        tdAtingMes.textContent = formatCurrency(r.atingMensal);

        const tdPercMes = document.createElement("td");
        tdPercMes.className = "align-right";
        tdPercMes.textContent = formatPercent(r.percMes);
        tdPercMes.classList.add(r.percMes >= 1 ? "status-ok" : "status-bad");

        const criarCellSemana = (valor) => {
          const td = document.createElement("td");
          td.className = "align-right";
          td.textContent = valor ? formatCurrency(valor) : "â€“";
          return td;
        };

        const [s1M, s2M, s3M, s4M, s5M] = r.semanasMeta;
        const [s1A, s2A, s3A, s4A, s5A] = r.semanasAting;

        tr.appendChild(tdEstado);
        tr.appendChild(tdRep);
        tr.appendChild(tdMetaMes);
        tr.appendChild(tdAtingMes);
        tr.appendChild(tdPercMes);
        tr.appendChild(criarCellSemana(s1M));
        tr.appendChild(criarCellSemana(s1A));
        tr.appendChild(criarCellSemana(s2M));
        tr.appendChild(criarCellSemana(s2A));
        tr.appendChild(criarCellSemana(s3M));
        tr.appendChild(criarCellSemana(s3A));
        tr.appendChild(criarCellSemana(s4M));
        tr.appendChild(criarCellSemana(s4A));
        tr.appendChild(criarCellSemana(s5M));
        tr.appendChild(criarCellSemana(s5A));

        tbody.appendChild(tr);
      });
    }

    function atualizarGraficos() {
      const semanaIndex = currentWeekIndex;
      const regsFiltrados = getRegistrosFiltrados();

      // destrÃ³i grÃ¡ficos antigos
      if (chartRepsSemana) chartRepsSemana.destroy();
      if (chartEstadosSemana) chartEstadosSemana.destroy();
      if (chartRankingMes) chartRankingMes.destroy();

      // --- GrÃ¡fico por representante na semana selecionada (estado filtrado) ---
      const ctxReps = document.getElementById("chartRepsSemana").getContext("2d");
      const labelsReps = regsFiltrados.map(r => r.representante);
      const metaReps = regsFiltrados.map(r => r.semanasMeta[semanaIndex] || 0);
      const atingReps = regsFiltrados.map(r => r.semanasAting[semanaIndex] || 0);

      chartRepsSemana = new Chart(ctxReps, {
        type: "bar",
        data: {
          labels: labelsReps,
          datasets: [
            {
              label: "Meta",
              data: metaReps
            },
            {
              label: "Atingido",
              data: atingReps
            }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y || 0;
                  return ctx.dataset.label + ": " + formatCurrency(v);
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });

      // --- GrÃ¡fico por estado (Semana selecionada) ---
      const ctxEstados = document.getElementById("chartEstadosSemana").getContext("2d");
      const estadosAgg = new Map(); // uf -> { meta, ating }

      regsFiltrados.forEach(r => {
        if (!estadosAgg.has(r.estado)) {
          estadosAgg.set(r.estado, { meta: 0, ating: 0 });
        }
        const obj = estadosAgg.get(r.estado);
        obj.meta += r.semanasMeta[semanaIndex] || 0;
        obj.ating += r.semanasAting[semanaIndex] || 0;
      });

      const labelsEstados = Array.from(estadosAgg.keys());
      const metaEstados = labelsEstados.map(uf => estadosAgg.get(uf).meta);
      const atingEstados = labelsEstados.map(uf => estadosAgg.get(uf).ating);

      chartEstadosSemana = new Chart(ctxEstados, {
        type: "bar",
        data: {
          labels: labelsEstados,
          datasets: [
            { label: "Meta", data: metaEstados },
            { label: "Atingido", data: atingEstados }
          ]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.y || 0;
                  return ctx.dataset.label + ": " + formatCurrency(v);
                }
              }
            }
          },
          scales: {
            y: {
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });

      // --- Ranking representantes (atingido no mÃªs) respeitando filtro de estado ---
      const ctxRanking = document.getElementById("chartRankingMes").getContext("2d");

      const arrayRanking = regsFiltrados
        .map(r => ({ nome: r.representante, valor: r.atingMensal }))
        .sort((a, b) => b.valor - a.valor)
        .slice(0, 15);

      const labelsRank = arrayRanking.map(x => x.nome);
      const dadosRank = arrayRanking.map(x => x.valor);

      chartRankingMes = new Chart(ctxRanking, {
        type: "bar",
        data: {
          labels: labelsRank,
          datasets: [
            {
              label: "Atingido mÃªs",
              data: dadosRank
            }
          ]
        },
        options: {
          responsive: true,
          indexAxis: "y",
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const v = ctx.parsed.x || 0;
                  return "Atingido: " + formatCurrency(v);
                }
              }
            }
          },
          scales: {
            x: {
              ticks: {
                callback: value => formatCurrency(value)
              }
            }
          }
        }
      });
    }

    function atualizarTudo() {
      if (!registros.length) return;
      atualizarResumoFiltro();
      atualizarGraficos();
    }

    // BotÃµes de semana
    document.querySelectorAll(".week-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const week = parseInt(btn.dataset.week, 10);
        currentWeekIndex = week;
        document.querySelectorAll(".week-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        atualizarTudo();
      });
    });
  </script>
</body>
</html>
